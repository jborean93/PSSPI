---
external help file: PSSPI.dll-Help.xml
Module Name: PSSPI
online version: https://www.github.com/jborean93/PSSPI/blob/main/docs/en-US/Step-InitSecContext.md
schema: 2.0.0
---

# Step-InitSecContext

## SYNOPSIS
Steps through a clients security context exchange.

## SYNTAX

```
Step-InitSecContext [-Context] <SecurityContext> [-Target] <String>
 [-ContextReq <InitiatorContextRequestFlags>] [-TargetDataRep <TargetDataRep>] [-InputBuffer <ISecBuffer[]>]
 [-OutputBuffer <ISecBuffer[]>] [<CommonParameters>]
```

## DESCRIPTION
Performs an exchange of security tokens required to set up a security context.
This is the first operation that should be performed on a security context and is required before the context can be used for other operations, like encryption.

Because the number of calls required relies on the security provider being used, this function may need to be called multiple times.
Check the `Result` value on the output object to see what needs to happen next.
These are the following result values that can be returned:

+ `Ok` - The context is complete no more stepping is required

+ `CompleteAndContinue` - A call to `Complete-AuthToken` (TBD) is required and one final token from the peer should be passed to `Step-InitSecContext`

+ `CompleteNeeded` - A call to `Complete-AuthToken` (TBD) is required

+ `ContinueNeeded` - The output token should be exchanged with the peer and input passed back into `Step-InitSecContext`

On the common security providers, NTLM, Kerberos, and Negotiate, the `Ok` and `ContinueNeeded` responses are expected.

## EXAMPLES

### Example 1: Set up a Kerberos security context
```powershell
PS C:\> $spn = "host/server.domain.com"
PS C:\> $ctx = New-SecContext -Credential (Get-SSPICredential -Package Kerberos)
PS C:\> $res = Step-InitSecContext -Context $ctx -Target $spn -OutputBuffer SECBUFFER_TOKEN -ContextReq ISC_REQ_ALLOCATE_MEMORY
PS C:\> Send-SecToken -Server server.domain.com -Data $res.Buffers[0].Data
PS C:\> $inToken = Receive-SecToken -Server server.domain.com
PS C:\> if ($inToken) {
...         $null = Step-InitSecContext -Context $ctx -Target $spn -InputBuffer $inToken
...     }
PS C:\> "done"
```

Creates a client context for Kerberos and exchanges the tokens to the server.
The code also optionally processes the input token from the server if there was one for mutual authentication.

## PARAMETERS

### -Context
The SSPI security context created with `New-SecContext`.

```yaml
Type: SecurityContext
Parameter Sets: (All)
Aliases:

Required: True
Position: 0
Default value: None
Accept pipeline input: False
Accept wildcard characters: False
```

### -ContextReq
Request options to use when creating the context.
Some options only work for certain security providers.
Requesting one of these options isn't guaranteed to be set once the context is complete, check the `Flags` value on the output result to verify the requested options were set on the context.

The `ISC_REQ_ALLOCATE_MEMORY` flag should be set if the output buffers need to be allocated by SSPI.

```yaml
Type: InitiatorContextRequestFlags
Parameter Sets: (All)
Aliases:
Accepted values: NONE, ISC_REQ_DELEGATE, ISC_REQ_MUTUAL_AUTH, ISC_REQ_REPLAY_DETECT, ISC_REQ_SEQUENCE_DETECT, ISC_REQ_CONFIDENTIALITY, ISC_REQ_USE_SESSION_KEY, ISC_REQ_PROMPT_FOR_CREDS, ISC_REQ_USE_SUPPLIED_CREDS, ISC_REQ_ALLOCATE_MEMORY, ISC_REQ_USE_DCE_STYLE, ISC_REQ_DATAGRAM, ISC_REQ_CONNECTION, ISC_REQ_CALL_LEVEL, ISC_REQ_FRAGMENT_SUPPLIED, ISC_REQ_EXTENDED_ERROR, ISC_REQ_STREAM, ISC_REQ_INTEGRITY, ISC_REQ_IDENTIFY, ISC_REQ_NULL_SESSION, ISC_REQ_MANUAL_CRED_VALIDATION, ISC_REQ_RESERVED1, ISC_REQ_FRAGMENT_TO_FIT, ISC_REQ_FORWARD_CREDENTIALS, ISC_REQ_NO_INTEGRITY, ISC_REQ_USE_HTTP_STYLE, ISC_REQ_UNVERIFIED_TARGET_NAME, ISC_REQ_CONFIDENTIALITY_ONLY

Required: False
Position: Named
Default value: NONE
Accept pipeline input: False
Accept wildcard characters: False
```

### -InputBuffer
The security buffers to use as the input to the stepping call.
This can be specified in 3 different ways

+ A byte array which is used as a `SECBUFFER_TOKEN` input buffer

+ A class that implements `ISecBuffer` that can be generated by `New-SecBuffer` or `New-ChannelBindingBuffer`

+ A sec buffer type that generates an empty/null buffer for that type

The input buffers that are required are dependent on the SSPI security provider being called.

```yaml
Type: ISecBuffer[]
Parameter Sets: (All)
Aliases:

Required: False
Position: Named
Default value: None
Accept pipeline input: False
Accept wildcard characters: False
```

### -OutputBuffer
The security buffers to use as the output to the stepping cal.
This can be specified in 3 different ways

+ A byte array which is used as a `SECBUFFER_TOKEN` input buffer

+ A class that implements `ISecBuffer` that can be generated by `New-SecBuffer` or `New-ChannelBindingBuffer`

+ A sec buffer type that generates an empty/null buffer for that type

When using the sec buffer type value, the context requirement flag `ISC_REQ_ALLOCATE_MEMORY` should be set which has SSPI allocate the memory for the output generated.
Otherwise a pre-allocated byte array should be specified for any output buffers needed.
Pre-allocated byte arrays should be large enough to contain the data that is needed.

The output buffers specified are used directly by SSPI so the input byte value may be mutated as it is.
The return value also contains the `Buffers` property which is another reference to the output buffers that were used with SSPI.

The output buffers used are dependent on the SSPI security provider being called.

```yaml
Type: ISecBuffer[]
Parameter Sets: (All)
Aliases:

Required: False
Position: Named
Default value: None
Accept pipeline input: False
Accept wildcard characters: False
```

### -Target
The service target name the client is authenticating against.
The value that should be used here depends on the SSPI security provider being called.
For `NTLM`, `Kerberos`, `Negotiate` this should be the Service Principal Name (`SPN`).
For Schannel this is typically the server name used to validate the certificate.

```yaml
Type: String
Parameter Sets: (All)
Aliases:

Required: True
Position: 1
Default value: None
Accept pipeline input: False
Accept wildcard characters: False
```

### -TargetDataRep
Controls how the output buffer data is to be aligned.

```yaml
Type: TargetDataRep
Parameter Sets: (All)
Aliases:
Accepted values: SECURITY_NETWORK_DREP, SECURITY_NATIVE_DREP

Required: False
Position: Named
Default value: SECURITY_NATIVE_DREP
Accept pipeline input: False
Accept wildcard characters: False
```

### CommonParameters
This cmdlet supports the common parameters: -Debug, -ErrorAction, -ErrorVariable, -InformationAction, -InformationVariable, -OutVariable, -OutBuffer, -PipelineVariable, -Verbose, -WarningAction, and -WarningVariable. For more information, see [about_CommonParameters](http://go.microsoft.com/fwlink/?LinkID=113216).

## INPUTS

### None
## OUTPUTS

### PSSPI.InitializeResult
The result from the initialize call. This object contains the following properties:

+ `Result` - The current status of the stepping call, use this to determine what the next step should be

+ `Buffers` - The output buffers from the stepping call, the buffer types correspond to the `-OutputBuffer` values specified

+ `Flags` - The context attributes, these should be ignored until `Result` is `Ok`

## NOTES

## RELATED LINKS

[InitializeSecurityContext](https://docs.microsoft.com/en-us/windows/win32/api/sspi/nf-sspi-initializesecuritycontextw)
